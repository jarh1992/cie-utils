<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>cie_utils - cie-utils 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">cie-utils 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <span class="sidebar-brand-text">cie-utils 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  
</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for cie_utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf8</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">colorsys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">npt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pytz</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span><span class="p">,</span> <span class="n">iqr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">filters</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage.color</span><span class="w"> </span><span class="kn">import</span> <span class="n">lab2lch</span><span class="p">,</span> <span class="n">lab2rgb</span><span class="p">,</span> <span class="n">rgb2lab</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.cluster</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgglomerativeClustering</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.mixture</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianMixture</span>

<span class="n">black_px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>


<div class="viewcode-block" id="std4elem">
<a class="viewcode-back" href="../index.html#cie_utils.std4elem">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">std4elem</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the element-wise standard deviation relative to the mean of</span>
<span class="sd">    non-zero elements in the input array.</span>

<span class="sd">    This function calculates the deviation of each element from the mean</span>
<span class="sd">    of all non-zero elements in `x`, returning an array where elements</span>
<span class="sd">    originally equal to zero remain zero.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : numpy.ndarray</span>
<span class="sd">        A 1D NumPy array of type float64. Elements with value zero are ignored</span>
<span class="sd">        in the mean and standard deviation calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        An array of the same shape as `x` containing the standard deviation</span>
<span class="sd">        for each element with respect to the mean of non-zero elements.</span>
<span class="sd">        Zero entries remain zero.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from cie_utils import std4elem</span>
<span class="sd">    &gt;&gt;&gt; x = np.array([1.0, 2.0, 0.0, 4.0], dtype=np.float64)</span>
<span class="sd">    &gt;&gt;&gt; std4elem(x)</span>
<span class="sd">    array([1.52752523, 0.15275252, 0., 1.37477271])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>



<div class="viewcode-block" id="enter_str_input">
<a class="viewcode-back" href="../index.html#cie_utils.enter_str_input">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">enter_str_input</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prompts the user for a text input and ensures it is not empty.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    text : str</span>
<span class="sd">        The message to display to the user.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The text string entered by the user.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the user&#39;s input is None or an empty string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">txt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">txt</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">return</span> <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">txt</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter a valid text&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="normalize_img">
<a class="viewcode-back" href="../index.html#cie_utils.normalize_img">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_img</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">rimg</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalizes an image based on a reference image.</span>

<span class="sd">    Pixel values of the input image are divided by the corresponding values</span>
<span class="sd">    of the reference image. NaN values resulting from division by zero are</span>
<span class="sd">    replaced by zero, and values are clipped to the range [0, 1].</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : npt.NDArray[np.float64]</span>
<span class="sd">        The image to normalize. Must be a NumPy array of type float64.</span>
<span class="sd">    rimg : npt.NDArray[np.float64]</span>
<span class="sd">        The reference image for normalization. Must be a NumPy array of type float64.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        The normalized image, with pixel values in the range [0, 1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">norm_img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">norm_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">rimg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">where</span><span class="o">=</span><span class="n">rimg</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">norm_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">norm_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">],</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">norm_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">norm_img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm_img</span></div>



<div class="viewcode-block" id="min_max">
<a class="viewcode-back" href="../index.html#cie_utils.min_max">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">min_max</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalizes an image using min-max scaling.</span>

<span class="sd">    This method independently normalizes each color channel of the image</span>
<span class="sd">    to a range of [0, 1] based on the minimum and maximum values of each channel.</span>
<span class="sd">    It is sensitive to outliers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : npt.NDArray[np.float64]</span>
<span class="sd">        The input image as a NumPy array of type float64, with 3 channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        The normalized image in the range [0, 1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">norm_img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">norm_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])))</span>
    <span class="n">norm_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])))</span>
    <span class="n">norm_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">norm_img</span></div>



<div class="viewcode-block" id="sd_by_px">
<a class="viewcode-back" href="../index.html#cie_utils.sd_by_px">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sd_by_px</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the standard deviation per RGB pixel.</span>

<span class="sd">    For each pixel in the image, calculates the standard deviation of its three</span>
<span class="sd">    color components (R, G, B).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : npt.NDArray[np.float64]</span>
<span class="sd">        The input image as a NumPy array of type float64, with 3 channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        A 2D array containing the standard deviation of the RGB values for each pixel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">image_array</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
    <span class="n">std_dev_rgb</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">image_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">std_dev_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">std_dev_rgb</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">std_dev_rgb</span></div>



<div class="viewcode-block" id="sd_by_elem">
<a class="viewcode-back" href="../index.html#cie_utils.sd_by_elem">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sd_by_elem</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the standard deviation per color component (R, G, B) for each pixel.</span>

<span class="sd">    For each color channel (red, green, blue), this function calculates the</span>
<span class="sd">    standard deviation of pixels that are greater than zero. If a pixel</span>
<span class="sd">    is zero, its individual standard deviation is considered zero.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : npt.NDArray[np.float64]</span>
<span class="sd">        The input image as a NumPy array of type float64, with 3 channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        An array with the same shape as the input image, where each element</span>
<span class="sd">        represents the standard deviation of the corresponding color component.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">img_r</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">img_g</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">img_b</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">std_array</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">std_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">std4elem</span><span class="p">(</span><span class="n">img_r</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">std_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">std4elem</span><span class="p">(</span><span class="n">img_g</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">std_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">std4elem</span><span class="p">(</span><span class="n">img_b</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">std_array</span></div>



<div class="viewcode-block" id="rm_bg">
<a class="viewcode-back" href="../index.html#cie_utils.rm_bg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rm_bg</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">sd_val</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sdimg</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the background from a normalized image based on a standard deviation value.</span>

<span class="sd">    Pixels whose value (or the value in `sdimg` if provided) is less than</span>
<span class="sd">    or equal to `sd_val` are considered part of the background and are set to zero.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : npt.NDArray[np.float64]</span>
<span class="sd">        The normalized input image, of type float64.</span>
<span class="sd">    sd_val : float</span>
<span class="sd">        The standard deviation threshold value. Pixels with a standard</span>
<span class="sd">        deviation below this value are considered background.</span>
<span class="sd">    sdimg : Any | None, optional</span>
<span class="sd">        An optional standard deviation image to use as a mask.</span>
<span class="sd">        If None, the input image `img` is used. Defaults to None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        The image without background, where background pixels have been set to zero</span>
<span class="sd">        and values have been clipped to the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># mode = max(set(data), key=data.count)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdimg</span> <span class="k">if</span> <span class="n">sdimg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">img</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sd_val</span>
    <span class="n">img_nobg</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">img_nobg</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">img_nobg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img_nobg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_nobg</span></div>



<div class="viewcode-block" id="rm_bg2channel">
<a class="viewcode-back" href="../index.html#cie_utils.rm_bg2channel">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rm_bg2channel</span><span class="p">(</span>
    <span class="n">chn</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
    <span class="n">sd_val</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sdimg</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the background from an image channel based on a standard deviation value.</span>

<span class="sd">    Pixels whose value in the channel (or the value in `sdimg` if provided)</span>
<span class="sd">    is less than or equal to `sd_val` are considered part of the background and are set to zero.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chn : npt.NDArray[np.float64]</span>
<span class="sd">        The input image channel, of type float64.</span>
<span class="sd">    sd_val : float</span>
<span class="sd">        The standard deviation threshold value. Pixels with a standard</span>
<span class="sd">        deviation below this value are considered background.</span>
<span class="sd">    sdimg : npt.NDArray[np.float64] | None, optional</span>
<span class="sd">        An optional standard deviation image to use as a mask.</span>
<span class="sd">        If None, the input channel `chn` is used. Defaults to None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        The image channel without background, where background pixels have been set to zero</span>
<span class="sd">        and values have been clipped to the range [0, 1].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">sdimg</span> <span class="k">if</span> <span class="n">sdimg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">chn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sd_val</span>
    <span class="n">chn_nobg</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">chn</span><span class="p">)</span>
    <span class="n">chn_nobg</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">chn</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">chn_nobg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">chn_nobg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">chn_nobg</span></div>



<span class="c1"># TODO: verify utility</span>
<div class="viewcode-block" id="img_preparation">
<a class="viewcode-back" href="../index.html#cie_utils.img_preparation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">img_preparation</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">rimg</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span> <span class="n">sd_val</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares an image by applying normalization, background removal, and color space transformations.</span>

<span class="sd">    The input image is normalized with a reference image, its background is</span>
<span class="sd">    removed using a standard deviation threshold, and then it is converted</span>
<span class="sd">    to CIELAB and CIELCh color spaces to extract their channels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : npt.NDArray[np.float64]</span>
<span class="sd">        The input image in RGB format (float64 values).</span>
<span class="sd">    rimg : npt.NDArray[np.float64]</span>
<span class="sd">        The reference image for normalization in RGB format (float64 values).</span>
<span class="sd">    sd_val : float</span>
<span class="sd">        The standard deviation threshold value for background removal.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list containing the L, a, b channels of the LAB image, and the</span>
<span class="sd">        C (chroma) and H (hue) channels of the LCh image.</span>
<span class="sd">        If the dimensions of `img` and `rimg` do not match, returns a list</span>
<span class="sd">        containing only the original input image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">rimg</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">img_norm</span> <span class="o">=</span> <span class="n">normalize_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rimg</span><span class="p">)</span>
        <span class="n">img_sd</span> <span class="o">=</span> <span class="n">sd_by_px</span><span class="p">(</span><span class="n">img_norm</span><span class="p">)</span>
        <span class="n">img_nobg</span> <span class="o">=</span> <span class="n">rm_bg</span><span class="p">(</span><span class="n">img_norm</span><span class="p">,</span> <span class="n">sd_val</span><span class="p">,</span> <span class="n">img_sd</span><span class="p">)</span>
        <span class="n">lab_img</span> <span class="o">=</span> <span class="n">rgb2lab</span><span class="p">(</span><span class="n">img_nobg</span><span class="p">)</span>
        <span class="n">lch_img</span> <span class="o">=</span> <span class="n">lab2lch</span><span class="p">(</span><span class="n">lab_img</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">lab_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">lab_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">lab_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">lch_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">lch_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">img</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_pdf">
<a class="viewcode-back" href="../index.html#cie_utils.get_pdf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_pdf</span><span class="p">(</span>
    <span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the Probability Density Function (PDF) for image data.</span>

<span class="sd">    This function filters non-zero pixels, calculates the number of bins</span>
<span class="sd">    using the Freedman-Diaconis rule, and estimates the PDF using</span>
<span class="sd">    Gaussian Kernel Density Estimation (KDE).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : npt.NDArray[np.float64]</span>
<span class="sd">        The input image as a NumPy array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[npt.NDArray[np.float64], npt.NDArray[np.float64], Any, int]</span>
<span class="sd">        - data : npt.NDArray[np.float64]</span>
<span class="sd">            The pixel data (non-zero values) of the image, rounded to one decimal place.</span>
<span class="sd">        - rng : npt.NDArray[np.float64]</span>
<span class="sd">            The range of values over which the density is calculated.</span>
<span class="sd">        - density : Any</span>
<span class="sd">            The density values of the estimated probability density function.</span>
<span class="sd">        - bins : int</span>
<span class="sd">            The number of bins calculated using the Freedman-Diaconis rule.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Return safe defaults for empty data</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="mi">1</span>
    <span class="c1"># Calculate the Interquartile Range (IQR)</span>
    <span class="n">iqr_value</span> <span class="o">=</span> <span class="n">iqr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">))</span>  <span class="c1"># IQR between the 25th and 75th percentile</span>

    <span class="c1"># Calculate the number of bins using the Freedman-Diaconis rule</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr_value</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Bin width</span>
    <span class="n">data_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Range of the data</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data_range</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">))</span>  <span class="c1"># Number of bins</span>
    <span class="c1"># print(&quot;#&quot; * 30, &quot;BINS&quot;, bins)</span>

    <span class="n">steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">/</span> <span class="n">bins</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
    <span class="n">density</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">density</span> <span class="o">=</span> <span class="n">density</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">bins</span></div>



<div class="viewcode-block" id="display_images">
<a class="viewcode-back" href="../index.html#cie_utils.display_images">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_images</span><span class="p">(</span>
    <span class="n">imgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">fsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">cmaps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">titles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_imgs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays a list of images in a grid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    imgs : list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list of images to display.</span>
<span class="sd">    cols : int, optional</span>
<span class="sd">        The number of columns in the display grid. Defaults to 1.</span>
<span class="sd">    fsize : tuple[int, int], optional</span>
<span class="sd">        The figure size (width, height) in inches. Defaults to (10, 5).</span>
<span class="sd">    cmaps : list[str] | None, optional</span>
<span class="sd">        A list of colormaps to apply to each image. If None, no colormap is applied.</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    titles : list[str] | None, optional</span>
<span class="sd">        A list of titles for each image. If None, no titles are displayed.</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    save_imgs : bool, optional</span>
<span class="sd">        If True, saves the images to a file instead of displaying them.</span>
<span class="sd">        The filename is based on the first title if available,</span>
<span class="sd">        otherwise &quot;test&quot; is used. Defaults to False.</span>
<span class="sd">    output_dir : Path, optional</span>
<span class="sd">        The directory where the images will be saved if `save_imgs` is True.</span>
<span class="sd">        Defaults to the current working directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of columns must be at least 1.&quot;</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="o">/</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>

    <span class="c1"># Asegurar formato uniforme para axes</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span> <span class="k">if</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axes</span><span class="p">])</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">cmaps</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">titles</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_imgs</span><span class="p">:</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;display_images_</span><span class="si">{</span><span class="n">dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">filename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_hist">
<a class="viewcode-back" href="../index.html#cie_utils.display_hist">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_hist</span><span class="p">(</span>
    <span class="n">imgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">fsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">titles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_imgs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_csv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays histograms and Probability Density Functions (PDFs) for a list of images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imgs : list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list of images (or image channels) for which to generate histograms.</span>
<span class="sd">    cols : int</span>
<span class="sd">        The number of columns in the histogram display grid.</span>
<span class="sd">    fsize : tuple[int, int], optional</span>
<span class="sd">        The figure size (width, height) in inches. Defaults to (10, 2).</span>
<span class="sd">    titles : list[str] | None, optional</span>
<span class="sd">        A list of titles for each histogram. If None, no titles are displayed.</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    xlabel : list[str], optional</span>
<span class="sd">        A list of labels for the x-axis of each histogram. Defaults to [&quot;x&quot;] for all.</span>
<span class="sd">    ylabel : list[str], optional</span>
<span class="sd">        A list of labels for the y-axis of each histogram. Defaults to [&quot;y&quot;] for all.</span>
<span class="sd">    save_imgs : bool, optional</span>
<span class="sd">        If True, saves the histograms to a file instead of displaying them.</span>
<span class="sd">        The filename is based on the first title if available,</span>
<span class="sd">        otherwise &quot;test&quot; is used. Defaults to False.</span>
<span class="sd">    save_csv : bool, optional</span>
<span class="sd">        If True, saves the density data (rng and density) of each histogram</span>
<span class="sd">        to a CSV file. Defaults to False.</span>
<span class="sd">    output_dir : Path, optional</span>
<span class="sd">        The directory where the images will be saved if `save_imgs` is True.</span>
<span class="sd">        Defaults to the current working directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">imgs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The image list is empty.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of columns must be at least 1.&quot;</span><span class="p">)</span>

    <span class="n">xlabel</span> <span class="o">=</span> <span class="n">xlabel</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="n">titles</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="o">/</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">export_csv</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">rng</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">density</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;density_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">axes</span><span class="p">)):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">get_pdf</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_csv</span><span class="p">:</span>
            <span class="n">export_csv</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_imgs</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;histograms_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_dir</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_plot">
<a class="viewcode-back" href="../index.html#cie_utils.display_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_plot</span><span class="p">(</span>
    <span class="n">imgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
    <span class="n">fsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">cmaps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">titles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays a combination of image, histogram, and pixel frequency scatter plot</span>
<span class="sd">    for each image in the list.</span>

<span class="sd">    For each image:</span>
<span class="sd">    1. The original image is displayed.</span>
<span class="sd">    2. A histogram and its Probability Density Function (PDF) are generated.</span>
<span class="sd">    3. A scatter plot of pixel value frequency is created.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imgs : list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list of images (or image channels) to visualize.</span>
<span class="sd">    fsize : tuple[int, int], optional</span>
<span class="sd">        The figure size (width, height) in inches. Defaults to (10, 2).</span>
<span class="sd">    cmaps : list[str] | None, optional</span>
<span class="sd">        A list of colormaps to apply to each image. If None, no colormap is applied.</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    titles : list[str] | None, optional</span>
<span class="sd">        A list of titles for each set of plots. If None, no titles are displayed.</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
        <span class="n">pixel_num</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pix_percentage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">pixel_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">pix_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">pixel_num</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">pix_percentage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">cmaps</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">titles</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">data</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">get_pdf</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">pix_label</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">data_flat</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">pixel_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">dts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">dts</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dts</span> <span class="ow">in</span> <span class="n">data_flat</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">cmaps</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">titles</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">data</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">get_pdf</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rng</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">pix_label</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="n">data_flat</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">pixel_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">dts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">dts</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dts</span> <span class="ow">in</span> <span class="n">data_flat</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="display_2d_scatter_plot">
<a class="viewcode-back" href="../index.html#cie_utils.display_2d_scatter_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_2d_scatter_plot</span><span class="p">(</span>
    <span class="n">imgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">fsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">titles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays 2D scatter plots of pixel frequency for a list of images.</span>

<span class="sd">    Each scatter plot shows pixel values (x-axis) against their</span>
<span class="sd">    frequency of occurrence (number of pixels with that value, y-axis). Only</span>
<span class="sd">    non-zero pixel values are considered.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imgs : list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list of images (or image channels) for which to generate scatter plots.</span>
<span class="sd">    cols : int</span>
<span class="sd">        The number of columns in the plot display grid.</span>
<span class="sd">    fsize : tuple[int, int], optional</span>
<span class="sd">        The figure size (width, height) in inches. Defaults to (10, 2).</span>
<span class="sd">    titles : list[str] | None, optional</span>
<span class="sd">        A list of titles for each scatter plot. If None, no titles are displayed.</span>
<span class="sd">        Defaults to None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list of NumPy arrays, where each array contains the frequency data</span>
<span class="sd">        of pixels ([pixel_value, frequency]) for each input image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plot_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of columns must be at least 1.&quot;</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span> <span class="o">/</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">data_flat</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">pixel_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">dts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">dts</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dts</span> <span class="ow">in</span> <span class="n">data_flat</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">titles</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">plot_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixel_freq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">imgs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">data_flat</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">pixel_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">dts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">dts</span><span class="p">)]</span> <span class="k">for</span> <span class="n">dts</span> <span class="ow">in</span> <span class="n">data_flat</span><span class="p">])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pixel_freq</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">if</span> <span class="n">titles</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">plot_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixel_freq</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">plot_data</span></div>



<div class="viewcode-block" id="display_3d_scatter_plot">
<a class="viewcode-back" href="../index.html#cie_utils.display_3d_scatter_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_3d_scatter_plot</span><span class="p">(</span>
    <span class="n">images</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]],</span>
    <span class="n">colors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a 3D scatter plot for classified data.</span>

<span class="sd">    Each dataset in `images` is represented as a series of points</span>
<span class="sd">    in a 3D space, useful for visualizing cluster distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images : list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list of NumPy arrays, where each array contains the coordinates</span>
<span class="sd">        (e.g., L, a, b from LAB) of the pixels in a cluster or group.</span>
<span class="sd">        Each array is expected to have 3 columns.</span>
<span class="sd">    colors : list[str] | None, optional</span>
<span class="sd">        A list of color strings for each set of points. If None,</span>
<span class="sd">        colors are automatically selected. Defaults to None.</span>
<span class="sd">    title : str | None, optional</span>
<span class="sd">        The title of the plot. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s2">&quot;3d&quot;</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">images</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">img</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;# px g</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># Consider more specific error handling if the index is out of range</span>
            <span class="nb">breakpoint</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_csv_data">
<a class="viewcode-back" href="../index.html#cie_utils.get_csv_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_csv_data</span><span class="p">(</span>
    <span class="n">now</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Saves data to a CSV file within a specific folder structure.</span>

<span class="sd">    The save path is `folder/csv/now/filename.csv`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    now : str</span>
<span class="sd">        A timestamp string to be used as a subfolder name within &#39;csv&#39;.</span>
<span class="sd">    data : npt.NDArray[np.float64]</span>
<span class="sd">        The data to save, must be a 2D NumPy array.</span>
<span class="sd">    filename : str</span>
<span class="sd">        The name of the CSV file (without the .csv extension).</span>
<span class="sd">    folder : Path</span>
<span class="sd">        The Path object of the base folder where the &#39;csv/now/&#39; structure will be created.</span>
<span class="sd">    col_names : list[str] | None, optional</span>
<span class="sd">        A list of names for the CSV columns. If None, no column names will be used.</span>
<span class="sd">        Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">col_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="s2">&quot;csv&quot;</span> <span class="o">/</span> <span class="n">now</span>
    <span class="n">filepath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">csv_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filepath</span> <span class="o">/</span> <span class="n">filename</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_csv_data_from_images">
<a class="viewcode-back" href="../index.html#cie_utils.get_csv_data_from_images">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_csv_data_from_images</span><span class="p">(</span>
    <span class="n">imgs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
    <span class="n">folder</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timezone</span><span class="o">=</span><span class="n">timezone</span><span class="p">(</span><span class="s2">&quot;America/Bogota&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts pixel frequency data from a list of images and saves them to CSV files.</span>

<span class="sd">    For each image in `imgs`, pixel frequencies are calculated</span>
<span class="sd">    (pixel values vs. number of occurrences) and saved to a CSV file.</span>
<span class="sd">    Files are organized by date and time within the specified `folder`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imgs : list[Any]</span>
<span class="sd">        A list of tuples where each tuple contains (image_name: str, image: npt.NDArray[np.float64]).</span>
<span class="sd">        The image must be a NumPy array. Pixels with zero value are ignored.</span>
<span class="sd">    folder : Path</span>
<span class="sd">        The Path object of the base folder where the CSV file structure will be created.</span>
<span class="sd">    col_names : list[str] | None, optional</span>
<span class="sd">        A list of names for the CSV columns (e.g., [&quot;pixel_value&quot;, &quot;frequency&quot;]).</span>
<span class="sd">        If None, no column names will be used. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">col_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">data_flat</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">pixel_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data_flat</span><span class="p">])</span>
        <span class="n">get_csv_data</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">pixel_freq</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">col_names</span><span class="p">)</span></div>



<div class="viewcode-block" id="extract_segmentation">
<a class="viewcode-back" href="../index.html#cie_utils.extract_segmentation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_segmentation</span><span class="p">(</span><span class="n">img_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rimg_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lbl_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dsfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts image segments based on label information and a dataset file.</span>

<span class="sd">    This function reads an image, segmentation coordinates from a label file,</span>
<span class="sd">    and category names from a YAML dataset file. It then creates masks,</span>
<span class="sd">    crops the regions of interest (ROI), and saves the segmented images and their</span>
<span class="sd">    references (if provided) into folders organized by category.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img_path : str</span>
<span class="sd">        Absolute path to the image to be segmented.</span>
<span class="sd">    rimg_path : str</span>
<span class="sd">        Absolute path to the reference image. Can be an empty string if no reference image.</span>
<span class="sd">    lbl_path : str</span>
<span class="sd">        Absolute path to the text file with segmentation label information.</span>
<span class="sd">    dest : str</span>
<span class="sd">        Absolute path to the destination folder where segmented images will be saved.</span>
<span class="sd">    dsfile : str</span>
<span class="sd">        Absolute path to the `dataset.yaml` file containing category names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">img_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">label_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lbl_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dest_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">img_name</span> <span class="o">=</span> <span class="n">image_path</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image_path</span><span class="p">))</span>
    <span class="n">ref_image_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rimg_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rimg_path</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ref_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ref_image_path</span><span class="p">))</span> <span class="k">if</span> <span class="n">ref_image_path</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dsfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">label_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">label</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">categ</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ln</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">categ_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="n">categ</span><span class="p">]</span>
            <span class="n">categ_folder</span> <span class="o">=</span> <span class="n">dest_path</span> <span class="o">/</span> <span class="n">categ_name</span>
            <span class="n">categ_folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">seg_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">ln</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">seg_coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span>
            <span class="n">seg_coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_coords</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span>
            <span class="n">seg_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">seg_coords</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="n">seg_coords</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">h1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">seg_coords</span><span class="p">)</span>
            <span class="n">polygon_only</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h1</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w1</span><span class="p">]</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">categ_folder</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">img_name</span><span class="si">}</span><span class="s2">_seg_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">polygon_only</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ref_image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                    <span class="n">ref_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">ref_image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ref_roi</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">ref_image</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
                <span class="n">ref_polygon_only</span> <span class="o">=</span> <span class="n">ref_roi</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h1</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w1</span><span class="p">]</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">categ_folder</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">img_name</span><span class="si">}</span><span class="s2">_seg_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">03</span><span class="si">}</span><span class="s2">_ref.png&quot;</span><span class="p">,</span>
                    <span class="n">ref_polygon_only</span><span class="p">,</span>
                <span class="p">)</span></div>



<div class="viewcode-block" id="extract_segmentation_main">
<a class="viewcode-back" href="../index.html#cie_utils.extract_segmentation_main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_segmentation_main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function for image segmentation extraction.</span>

<span class="sd">    Prompts the user for the necessary paths for the image, reference image,</span>
<span class="sd">    label file, and destination folder, then calls `extract_segmentation`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img_path</span> <span class="o">=</span> <span class="n">enter_str_input</span><span class="p">(</span><span class="s2">&quot;Enter the absolute path of the image: &quot;</span><span class="p">)</span>
    <span class="n">rimg_path</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the absolute path of the reference image (enter if not): &quot;</span><span class="p">)</span>
    <span class="n">label_path</span> <span class="o">=</span> <span class="n">enter_str_input</span><span class="p">(</span><span class="s2">&quot;Enter the absolute path of the image label: &quot;</span><span class="p">)</span>
    <span class="n">dest_path</span> <span class="o">=</span> <span class="n">enter_str_input</span><span class="p">(</span><span class="s2">&quot;Enter the absolute path of the destination folder: &quot;</span><span class="p">)</span>
    <span class="n">dataset_yaml_path</span> <span class="o">=</span> <span class="n">enter_str_input</span><span class="p">(</span><span class="s2">&quot;Enter the absolute path of the dataset.yaml file: &quot;</span><span class="p">)</span>
    <span class="n">extract_segmentation</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">rimg_path</span><span class="p">,</span> <span class="n">label_path</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">,</span> <span class="n">dataset_yaml_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="hsv_to_rgb">
<a class="viewcode-back" href="../index.html#cie_utils.hsv_to_rgb">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">hsv_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a color from HSV to RGB.</span>

<span class="sd">    HSV values are in the range [0, 1]. The RGB output is in the range [0, 255]</span>
<span class="sd">    and are integers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    h : float</span>
<span class="sd">        Hue component, in the range [0, 1].</span>
<span class="sd">    s : float</span>
<span class="sd">        Saturation component, in the range [0, 1].</span>
<span class="sd">    v : float</span>
<span class="sd">        Value/Brightness component, in the range [0, 1].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        A NumPy array of integers representing the color in RGB format [R, G, B],</span>
<span class="sd">        with values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="mi">255</span>
    <span class="k">return</span> <span class="n">color</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_rgb_spectrum">
<a class="viewcode-back" href="../index.html#cie_utils.create_rgb_spectrum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_rgb_spectrum</span><span class="p">(</span><span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an RGB color spectrum by varying the Hue in HSV space.</span>

<span class="sd">    The spectrum goes from a hue close to red (0.75) to red (0),</span>
<span class="sd">    keeping saturation and value at maximum.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_steps : int</span>
<span class="sd">        The number of steps (colors) to generate in the spectrum.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[int]</span>
<span class="sd">        A list of NumPy arrays, where each array represents an RGB color</span>
<span class="sd">        ([R, G, B]) with integer values in the range [0, 255].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Values for the HSV components (Hue, Saturation, Value)</span>
    <span class="n">h_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Saturation</span>
    <span class="n">v</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Value</span>

    <span class="c1"># Convert HSV to RGB for each hue value</span>
    <span class="n">rgb_spectrum</span> <span class="o">=</span> <span class="p">[</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">h_values</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">rgb_spectrum</span></div>



<div class="viewcode-block" id="false_color_scale">
<a class="viewcode-back" href="../index.html#cie_utils.false_color_scale">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">false_color_scale</span><span class="p">(</span><span class="n">channel</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">color_list</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">ranges_list</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a false color scale to a single-channel image.</span>

<span class="sd">    Assigns colors from a `color_list` to the pixels of `channel`</span>
<span class="sd">    based on the ranges specified in `ranges_list`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    channel : Any</span>
<span class="sd">        The single-channel image to which the color scale will be applied.</span>
<span class="sd">        Expected to be a 2D NumPy array.</span>
<span class="sd">    color_list : Any</span>
<span class="sd">        A list of RGB colors ([R, G, B]) to assign to the ranges.</span>
<span class="sd">    ranges_list : Any</span>
<span class="sd">        A list of tuples or lists, where each tuple represents a range `(min_val, max_val]`.</span>
<span class="sd">        Pixel values within this range will be mapped to the corresponding color.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        A new image with the false color scale applied, of integer type and 3 channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">new_chroma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranges_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">channel</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">new_chroma</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_list</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">new_chroma</span> <span class="o">=</span> <span class="n">new_chroma</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_chroma</span></div>



<div class="viewcode-block" id="mix_images">
<a class="viewcode-back" href="../index.html#cie_utils.mix_images">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">mix_images</span><span class="p">(</span><span class="n">img1</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">img2</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Blends two images: an original image and a false-color image.</span>

<span class="sd">    Pixels in the overlay image that are not completely black (i.e.,</span>
<span class="sd">    do not have an RGB component sum equal to zero) replace the</span>
<span class="sd">    corresponding pixels in the original image. If a pixel in `img2` is</span>
<span class="sd">    black, the original image&#39;s pixel is retained.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img1 : Any</span>
<span class="sd">        The original image (e.g., RGB). A NumPy array with 3 channels is expected.</span>
<span class="sd">    img2 : Any</span>
<span class="sd">        The image to overlay. A NumPy array with 3 channels is expected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Any</span>
<span class="sd">        The blended image, where non-black pixels from `img2` have replaced</span>
<span class="sd">        pixels from `img1`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">new_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">img2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">img2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">img1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_img</span></div>



<div class="viewcode-block" id="sort_classifier_results">
<a class="viewcode-back" href="../index.html#cie_utils.sort_classifier_results">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sort_classifier_results</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">centers</span><span class="p">,</span> <span class="n">ordered</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sorts clustering results (e.g., K-means) based on</span>
<span class="sd">    the number of pixels or closeness to LAB reference values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : npt.NDArray</span>
<span class="sd">        The original image (flattened if used for clustering) in LAB color space.</span>
<span class="sd">    labels : npt.NDArray</span>
<span class="sd">        The cluster identifiers assigned to each pixel.</span>
<span class="sd">    centers : npt.NDArray</span>
<span class="sd">        The coordinates (centroids) of the clusters in LAB color space.</span>
<span class="sd">    ordered : str</span>
<span class="sd">        The sorting method to use.</span>
<span class="sd">        Must be &quot;by_pixel&quot; (by number of pixels in each cluster, descending)</span>
<span class="sd">        or &quot;reference_values&quot; (by closeness to predefined LAB reference values).</span>
<span class="sd">    n_ref : int</span>
<span class="sd">        Index of the reference points to use if `ordered` is &quot;reference_values&quot;.</span>
<span class="sd">        Must be 0 or 1, selecting between two sets of LAB references.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        If True, prints detailed information about the sorting process</span>
<span class="sd">        and the average colors of the clusters. Defaults to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple[npt.NDArray, list[npt.NDArray]]</span>
<span class="sd">        - centers : npt.NDArray</span>
<span class="sd">            The sorted cluster centroids.</span>
<span class="sd">        - ordered_images : list[npt.NDArray]</span>
<span class="sd">            A list of images, where each element is the segmented image</span>
<span class="sd">            corresponding to a cluster, sorted according to the specified method.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the `ordered` sorting method is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">segmented_data</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span>
    <span class="n">segmented_image</span> <span class="o">=</span> <span class="n">segmented_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pixel_num</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">result_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">segmented_image</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">centers</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                <span class="n">result_image</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>

        <span class="n">pixel_num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">result_image</span><span class="p">))</span>
        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_image</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ordered</span> <span class="o">==</span> <span class="s2">&quot;by_pixel&quot;</span><span class="p">:</span>
        <span class="c1"># Original behavior</span>
        <span class="n">indices_ordenados</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pixel_num</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="n">indices_ordenados</span><span class="p">]</span>
        <span class="n">ordered_images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">li</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">li</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ordered</span> <span class="o">==</span> <span class="s2">&quot;reference_values&quot;</span><span class="p">:</span>
        <span class="n">ref_points</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">82.50</span><span class="p">,</span> <span class="mf">13.58</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.27</span><span class="p">],</span> <span class="p">[</span><span class="mf">92.24</span><span class="p">,</span> <span class="mf">14.87</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.85</span><span class="p">],</span> <span class="p">[</span><span class="mf">82.50</span><span class="p">,</span> <span class="mf">13.58</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.27</span><span class="p">]]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">30.69</span><span class="p">,</span> <span class="mf">28.91</span><span class="p">,</span> <span class="o">-</span><span class="mf">48.47</span><span class="p">],</span> <span class="p">[</span><span class="mf">60.29</span><span class="p">,</span> <span class="mf">18.98</span><span class="p">,</span> <span class="o">-</span><span class="mf">14.80</span><span class="p">],</span> <span class="p">[</span><span class="mf">81.24</span><span class="p">,</span> <span class="mf">14.85</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.15</span><span class="p">]]),</span>
        <span class="p">]</span>

        <span class="n">mean_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Average LAB colors of each cluster ---&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mean_colors</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: L=</span><span class="si">{</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, a=</span><span class="si">{</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, b=</span><span class="si">{</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ordered_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">available_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_colors</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ref_points</span><span class="p">[</span><span class="n">n_ref</span><span class="p">]):</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mean_colors</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">available_indexes</span><span class="p">]</span>
            <span class="n">closest_idx_in_available</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">)</span>
            <span class="n">assigned_cluster</span> <span class="o">=</span> <span class="n">available_indexes</span><span class="p">[</span><span class="n">closest_idx_in_available</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Reference </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: Assigned Cluster </span><span class="si">{</span><span class="n">assigned_cluster</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; (Distance: </span><span class="si">{</span><span class="n">distances</span><span class="p">[</span><span class="n">closest_idx_in_available</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

            <span class="n">ordered_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assigned_cluster</span><span class="p">)</span>
            <span class="n">available_indexes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">closest_idx_in_available</span><span class="p">)</span>

        <span class="n">ordered_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">available_indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># TODO: Review reference</span>
        <span class="n">indices_ordenados</span> <span class="o">=</span> <span class="p">[</span><span class="n">ordered_indexes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">n_ref</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">ordered_indexes</span>

        <span class="c1"># The last cluster</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last cluster assigned: Cluster </span><span class="si">{</span><span class="n">available_indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">indices_ordenados</span><span class="p">)</span>

        <span class="n">centers</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span><span class="n">indices_ordenados</span><span class="p">]</span>
        <span class="n">ordered_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices_ordenados</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid order method: </span><span class="si">{</span><span class="n">ordered</span><span class="si">}</span><span class="s2">. Use &#39;by_pixel&#39; or &#39;reference_values&#39;.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">centers</span><span class="p">,</span> <span class="n">ordered_images</span></div>



<div class="viewcode-block" id="classifier_model">
<a class="viewcode-back" href="../index.html#cie_utils.classifier_model">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">classifier_model</span><span class="p">(</span><span class="n">clf_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;by_pixel&quot;</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a classification model (K-means, GaussianMixture, or AgglomerativeClustering)</span>
<span class="sd">    to images and sorts the results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    clf_model : {&quot;Kmeans&quot;, &quot;GaussianMixture&quot;, &quot;AgglomerativeClustering&quot;}</span>
<span class="sd">        The type of classification model to use.</span>

<span class="sd">    params : tuple</span>
<span class="sd">        Specific parameters for the classification model.</span>

<span class="sd">        - For &quot;Kmeans&quot;: (img, k, stop_criteria, number_of_attempts, centroid_initialization_strategy)</span>
<span class="sd">        - For &quot;GaussianMixture&quot;: (img, k)</span>
<span class="sd">        - For &quot;AgglomerativeClustering&quot;: (img, k, linkage)</span>

<span class="sd">        `img` can be a single image or a list of images.</span>

<span class="sd">    order : {&quot;by_pixel&quot;, &quot;reference_values&quot;}, optional</span>
<span class="sd">        Method to sort the resulting clusters.</span>
<span class="sd">        - &quot;by_pixel&quot;: sorts by the number of pixels in each cluster (descending).</span>
<span class="sd">        - &quot;reference_values&quot;: sorts by the closeness of centroids to reference LAB values.</span>
<span class="sd">        Defaults to &quot;by_pixel&quot;.</span>

<span class="sd">    n_ref : int, optional</span>
<span class="sd">        Reference number (0 or 1) to select the set of reference LAB values</span>
<span class="sd">        when `order` is &quot;reference_values&quot;. Defaults to 1.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of list</span>
<span class="sd">        A tuple with:</span>

<span class="sd">        - centers : list of ndarray</span>
<span class="sd">            The sorted cluster centroids (or means) for each image.</span>

<span class="sd">        - ordered_images : list of list of ndarray</span>
<span class="sd">            A list of lists, where each sublist contains the segmented images</span>
<span class="sd">            sorted by cluster for the corresponding image.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the `clf_model` classifier type is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">images</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">images</span>
    <span class="n">lbl_cen</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">clf_model</span> <span class="o">==</span> <span class="s2">&quot;Kmeans&quot;</span><span class="p">:</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">stop_criteria</span><span class="p">,</span> <span class="n">number_of_attempts</span><span class="p">,</span> <span class="n">centroid_initialization_strategy</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">centers</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span>
                <span class="n">k</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">stop_criteria</span><span class="p">,</span>
                <span class="n">number_of_attempts</span><span class="p">,</span>
                <span class="n">centroid_initialization_strategy</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">lbl_cen</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">labels</span><span class="p">,</span> <span class="n">centers</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">clf_model</span> <span class="o">==</span> <span class="s2">&quot;GaussianMixture&quot;</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">gm</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">init_params</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">means_</span>
            <span class="n">lbl_cen</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">labels</span><span class="p">,</span> <span class="n">centers</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">clf_model</span> <span class="o">==</span> <span class="s2">&quot;AgglomerativeClustering&quot;</span><span class="p">:</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">linkage</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="n">agglom</span> <span class="o">=</span> <span class="n">AgglomerativeClustering</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">linkage</span><span class="o">=</span><span class="n">linkage</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">agglom</span><span class="o">.</span><span class="n">labels_</span>
            <span class="c1"># Compute centers as the mean of the points in each cluster</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cluster_label</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">cluster_points</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">cluster_label</span><span class="p">]</span>
                <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cluster_points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">centers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
            <span class="n">lbl_cen</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">labels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centers</span><span class="p">)))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid classifier type&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">list</span><span class="p">()],</span> <span class="p">[[</span><span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()]]</span>

    <span class="n">scr</span> <span class="o">=</span> <span class="p">[</span><span class="n">sort_classifier_results</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">order</span><span class="p">,</span> <span class="n">n_ref</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">lc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">lbl_cen</span><span class="p">)]</span>
    <span class="n">centers</span><span class="p">,</span> <span class="n">ordered_images</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">scr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">centers</span><span class="p">,</span> <span class="n">ordered_images</span></div>



<div class="viewcode-block" id="plot_rgb_3d">
<a class="viewcode-back" href="../index.html#cie_utils.plot_rgb_3d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_rgb_3d</span><span class="p">(</span><span class="n">images</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">colors</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a 3D scatter plot of RGB pixels.</span>

<span class="sd">    Allows visualizing the distribution of colors in 3D space (R, G, B).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    images : Any | list[Any]</span>
<span class="sd">        An image or a list of images. Images should be NumPy arrays</span>
<span class="sd">        representing pixel data (e.g., RGB). If it&#39;s a 3D image</span>
<span class="sd">        (height, width, 3), it will be flattened to (N, 3).</span>
<span class="sd">    colors : Any | list[Any]</span>
<span class="sd">        The color or a list of colors for the points in the scatter plot.</span>
<span class="sd">        Must match the number of images if it&#39;s a list.</span>
<span class="sd">        # Example: colors = [np.array([255, 0, 0]), np.array([0, 255, 0]), np.array([0, 0, 255])]</span>
<span class="sd">    title : Any | list[Any]</span>
<span class="sd">        The title or a list of titles for the plot(s).</span>
<span class="sd">        Must match the number of images if it&#39;s a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">images</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">images</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">colors</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">title</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">),</span> <span class="mi">5</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">})</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ax</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">ax</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">ax</span><span class="p">)):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">na</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># if it&#39;s a tensor</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># flatten to a 2d array</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">T</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;# px g0: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># RGB 0-1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># Consider more specific error handling</span>
            <span class="nb">breakpoint</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="blur_img">
<a class="viewcode-back" href="../index.html#cie_utils.blur_img">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">blur_img</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a Gaussian filter to an image.</span>

<span class="sd">    Uses `skimage.filters.gaussian` with a `sigma` of 1 and `truncate` of 1,</span>
<span class="sd">    resulting in a 3x3 Gaussian kernel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : npt.NDArray</span>
<span class="sd">        The input image. Pixel values are expected to be</span>
<span class="sd">        in the range [0.0, 1.0] (float) or [0, 255] (uint8).</span>
<span class="sd">        The `skimage.filters.gaussian` function automatically handles data types.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        The image with the Gaussian filter applied. The output will be of type float64.</span>
<span class="sd">        If the input was RGB, the output will also be RGB.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">filters</span><span class="o">.</span><span class="n">gaussian</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channel_axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="clahe_img">
<a class="viewcode-back" href="../index.html#cie_utils.clahe_img">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clahe_img</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">illumination_axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">top_val</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies Contrast Limited Adaptive Histogram Equalization (CLAHE)</span>
<span class="sd">    to the image, specifically to the illumination channel.</span>

<span class="sd">    The illumination channel is scaled to [0, 255] before applying CLAHE, and then</span>
<span class="sd">    rescaled back to its original range [0, `top_val`].</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : npt.NDArray</span>
<span class="sd">        The input image. Expected to be an image in a color space</span>
<span class="sd">        where one channel represents illumination (e.g., the L channel of LAB).</span>
<span class="sd">    illumination_axis : int</span>
<span class="sd">        The index of the channel representing illumination in the image (e.g., 0 for L in LAB).</span>
<span class="sd">    top_val : float</span>
<span class="sd">        The maximum value the illumination channel can take in its original range</span>
<span class="sd">        (e.g., 100 for L in LAB).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray</span>
<span class="sd">        The image with CLAHE applied to the illumination channel, maintaining float64 data type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l_ax</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">illumination_axis</span><span class="p">]</span>
    <span class="n">l_ax</span> <span class="o">*=</span> <span class="mi">255</span> <span class="o">/</span> <span class="n">top_val</span>
    <span class="n">l_ax</span> <span class="o">=</span> <span class="n">l_ax</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">l_ax_eq</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">l_ax</span><span class="p">)</span>  <span class="c1"># CLAHE range is [0,255] (cv2 range), from lab/skimage.lab L range [0,100]</span>
    <span class="n">l_ax_eq</span> <span class="o">=</span> <span class="n">l_ax_eq</span> <span class="o">*</span> <span class="p">(</span><span class="n">top_val</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)</span>
    <span class="n">image_eq</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">image_eq</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">illumination_axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_ax_eq</span>  <span class="c1"># float64</span>
    <span class="k">return</span> <span class="n">image_eq</span></div>



<div class="viewcode-block" id="pca_img">
<a class="viewcode-back" href="../index.html#cie_utils.pca_img">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pca_img</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">,</span> <span class="n">comp_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs Principal Component Analysis (PCA) on the pixels of an image.</span>

<span class="sd">    Transforms each pixel (interpreted as a point in a 3D space, e.g., RGB or LAB)</span>
<span class="sd">    to its 3 principal components.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : npt.NDArray</span>
<span class="sd">        The input image. A NumPy array with pixels expected</span>
<span class="sd">        in the last dimension (e.g., (height, width, channels)).</span>
<span class="sd">    comp_num : int</span>
<span class="sd">        The number of principal components to retain.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    npt.NDArray[np.float64]</span>
<span class="sd">        A NumPy array representing the transformed image in PCA space,</span>
<span class="sd">        where each pixel now has 3 values corresponding to its principal components.</span>
<span class="sd">        The shape will be (N, 3) where N is the total number of pixels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>  <span class="c1"># This import is crucial for the function and test</span>
        <span class="n">PCA</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">comp_num</span><span class="p">)</span>
    <span class="n">image_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">image_pca</span></div>



<div class="viewcode-block" id="transform_img">
<a class="viewcode-back" href="../index.html#cie_utils.transform_img">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_img</span><span class="p">(</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">],</span>
    <span class="n">bg_pixel</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">blur</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">lab</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">clahe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a series of transformations to an image: Gaussian blur,</span>
<span class="sd">    conversion to L*a*b* color space, and adaptive histogram equalization (CLAHE).</span>

<span class="sd">    Pixels that are black (considered background) can be replaced by a</span>
<span class="sd">    specified `bg_pixel` before transformations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image : npt.NDArray[np.float64]</span>
<span class="sd">        The normalized input image, in the range [0.0, 1.0]. RGB format is expected.</span>
<span class="sd">    bg_pixel : npt.NDArray[np.float64] | None, optional</span>
<span class="sd">        An RGB pixel (float64) to insert as background where the original image</span>
<span class="sd">        was black. If None, black pixels are retained. Defaults to None.</span>
<span class="sd">    blur : bool, optional</span>
<span class="sd">        If True, applies a Gaussian blur to the image. Defaults to True.</span>
<span class="sd">    lab : bool, optional</span>
<span class="sd">        If True, converts the image to CIELAB color space. Defaults to True.</span>
<span class="sd">    clahe : bool, optional</span>
<span class="sd">        If True, applies CLAHE to the illumination channel of the image (only if `lab` is True).</span>
<span class="sd">        Defaults to True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list[npt.NDArray[np.float64]]</span>
<span class="sd">        A list containing:</span>

<span class="sd">        - blur_image : npt.NDArray[np.float64]</span>
<span class="sd">            The blurred image (or the original image if `blur` is False).</span>
<span class="sd">        - rgb_image_eq : npt.NDArray[np.float64]</span>
<span class="sd">            The resulting image after all transformations, converted back to RGB.</span>
<span class="sd">        - lab_image_eq : npt.NDArray[np.float64]</span>
<span class="sd">            The resulting image in CIELAB color space, flattened to (N, 3)</span>
<span class="sd">            where N is the total number of pixels.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># background mask (information different from that of the globule)</span>
    <span class="n">bg_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">image</span> <span class="o">==</span> <span class="n">black_px</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bg_pixel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">image</span><span class="p">[</span><span class="n">bg_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">bg_pixel</span>

    <span class="n">blur_image</span> <span class="o">=</span> <span class="n">blur_img</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">if</span> <span class="n">blur</span> <span class="k">else</span> <span class="n">image</span>
    <span class="n">lab_image</span> <span class="o">=</span> <span class="n">rgb2lab</span><span class="p">(</span><span class="n">blur_image</span><span class="p">)</span> <span class="k">if</span> <span class="n">lab</span> <span class="k">else</span> <span class="n">blur_image</span>
    <span class="n">lab_image_eq</span> <span class="o">=</span> <span class="n">clahe_img</span><span class="p">(</span><span class="n">lab_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">clahe</span> <span class="k">else</span> <span class="n">lab_image</span>
    <span class="n">rgb_image_eq</span> <span class="o">=</span> <span class="n">lab2rgb</span><span class="p">(</span><span class="n">lab_image_eq</span><span class="p">)</span> <span class="k">if</span> <span class="n">lab</span> <span class="k">else</span> <span class="n">lab_image_eq</span>

    <span class="k">if</span> <span class="n">bg_pixel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lab</span><span class="p">:</span>
        <span class="n">lab_bg_pixel</span> <span class="o">=</span> <span class="n">rgb2lab</span><span class="p">(</span><span class="n">bg_pixel</span><span class="p">)</span>
        <span class="n">lab_image_eq</span><span class="p">[</span><span class="n">bg_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">lab_bg_pixel</span>

    <span class="n">lab_image_eq</span> <span class="o">=</span> <span class="n">lab_image_eq</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">lab_image_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">lab_image_eq</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">blur_image</span><span class="p">,</span> <span class="n">rgb_image_eq</span><span class="p">,</span> <span class="n">lab_image_eq</span><span class="p">]</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=01f34227"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>